<div data-controller="appointment-modal">
  <div class="flex justify-center">
    <div class="bg-white rounded-lg shadow w-full md:w-5/6 lg:w-2/3">
      <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
        <h3 class="text-lg leading-6 font-medium text-gray-900">
          Appointments
        </h3>
        <div class="flex items-center">
          <%= link_to "Week", appointments_path(view: 'week'), class: "px-4 py-2 rounded-l-md #{'bg-blue-500 text-white' if params[:view] != 'month'}" %>
          <%= link_to "Month", appointments_path(view: 'month'), class: "px-4 py-2 rounded-r-md #{'bg-blue-500 text-white' if params[:view] == 'month'}" %>
        </div>
      </div>
      <div class="px-4 py-5 sm:p-6">
        <% if params[:view] == 'month' %>
          <%= month_calendar(events: @appointments, class: "text-center border-collapse w-full") do |date, appointments| %>
            <div class="px-4 py-8 border border-gray-200 min-h-32" data-action="click->appointment-modal#openModal" data-appointment-modal-target="date" data-date="<%= date.strftime('%Y-%m-%d') %>">              
              <div class="text-lg font-semibold text-gray-800">
                <%= date.day %>
              </div>
              <% appointments.each do |appointment| %>
                <div class="mt-2">
                  <%= link_to "#{appointment.client.first_name} #{appointment.client.last_name}", appointment_path(appointment), remote: true, class: "text-blue-500 hover:text-blue-700" %>
                  <div class="text-sm text-gray-600">
                    <% if appointment.appointment_type.present? %>
                      <%= appointment.appointment_type.name %>
                    <% else %>
                      No Appointment Type
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <table class="text-center border-collapse w-full">
            <thead>
              <tr>
                <th class="px-4 py-2 border border-gray-200"></th>
                <% @date_range.each do |date| %>
                  <th class="px-4 py-2 border border-gray-200">
                    <%= date.strftime('%a %d') %>
                  </th>
                <% end %>
              </tr>
            </thead>
            <tbody>
              <% (0..95).each do |index| %>
                <% time = @date_range.first.beginning_of_day + (index * 15.minutes) %>
                <tr>
                  <% if index % 4 == 0 %>
                    <td class="px-4 py-2 border border-gray-200 font-semibold text-gray-800" rowspan="4">
                      <%= time.strftime('%l %p') %>
                    </td>
                  <% end %>
                  <% @date_range.each do |date| %>
                    <td class="px-4 py-2 border border-gray-200 cursor-pointer h-16"
                        data-action="click->appointment-modal#openModal"
                        data-appointment-modal-target="date"
                        data-date="<%= date.strftime('%Y-%m-%d') %>"
                        data-time="<%= time.strftime('%H:%M') %>">
                      <% @appointments.select { |a| a.start_time.to_date == date && a.start_time.strftime('%H:%M') == time.strftime('%H:%M') }.each do |appointment| %>
                        <div class="mt-2">
                          <%= link_to "#{appointment.client.first_name} #{appointment.client.last_name}", appointment_path(appointment), remote: true, class: "text-blue-500 hover:text-blue-700" %>
                          <div class="text-sm text-gray-600">
                            <% if appointment.appointment_type.present? %>
                              <%= appointment.appointment_type.name %>
                            <% else %>
                              No Appointment Type
                            <% end %>
                          </div>
                        </div>
                      <% end %>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true" data-appointment-modal-target="modal">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
            New Appointment
          </h3>
            <%= render 'form', appointment: @appointment %>
        </div>
        <div class="px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" data-action="click->appointment-modal#closeModal">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
</div>